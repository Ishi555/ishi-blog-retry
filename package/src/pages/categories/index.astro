---
import { HomeLayout } from "charm:layouts";
import { getPostEntries } from "../../utils/collectionUtils";

const entries = await getPostEntries();
const categories = entries
  .map((entry) => entry.data.category)
  .filter(Boolean)
  .map((category) => ({
    category: category!,
    posts: entries
      .filter((entry) => entry.data.category === category)
      .map((entry) => ({
        title: entry.data.title,
        slug: entry.slug,
      })),
  }));

const totalPages = Math.ceil(categories.length / 20);

const p = Astro.url.searchParams.get("p");
const currentPage = p ? parseInt(p) : 0;
---

<style>
  .nav {
    background: var(--charm-card-background);
    padding: 1rem;
    margin-bottom: 2rem;
    border-radius: 0.5rem;
  }

  .category-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  ul {
    list-style: none;
  }

  .post-item {
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 0.25rem;
    background: var(--charm-card-background);
    transition: background-color 0.2s;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;

    &:hover {
      background: var(--charm-contrast-color-3);
    }
  }

  .pagination {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 2rem;
  }

  .pagination-button {
    padding: 0.5rem 1rem;
    background: #fee2e2;
    border: none;
    border-radius: 0.25rem;
    color: var(--charm-font-color);
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .pagination-button:hover {
    background: #fecaca;
  }

  .pagination-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .pagination-current {
    padding: 0.5rem 1rem;
    background: #f5f5f5;
    border-radius: 0.25rem;
  }

  .category-container {
    position: relative;
    padding-left: 60px;
  }

  .view-more {
    display: inline-block;
    color: #f97316;
    text-decoration: none;
  }

  .pagination::before {
    content: "";
    position: absolute;
    left: 20px;
    top: -30px;
    height: 30px;
    border-left: 2px solid #ccc;
  }
</style>
<HomeLayout>
  <h1>Blog Categories</h1>

  <div>
    {
      categories.slice(0, 20).map((category) => (
        <section
          class="category-container"
          aria-labelledby={`category-${category.category.toLowerCase()}`}
        >
          <h2
            id={`category-${category.category.toLowerCase()}`}
            class="category-title"
          >
            {category.category}
          </h2>
          <ul class="post-list">
            {category.posts.slice(0, 3).map((post) => (
              <li>
                <div class="horizontal-line post-line" />
                <a href={`/posts/${post.slug}`} class="post-item">
                  {post.title}
                </a>
              </li>
            ))}
          </ul>
          {category.posts.length > 3 && (
            <a href={`/categories/${category.category}`} class="view-more">
              View More
            </a>
          )}
        </section>
      ))
    }
    {
      categories.length > 20 && (
        <nav class="pagination" aria-label="Pagination">
          <a
            class="pagination-button"
            href={`?p=${currentPage - 1}`}
            aria-disabled={currentPage === 1}
            aria-label="Go to previous page"
          >
            Prev
          </a>
          <span class="pagination-current" aria-current="page">
            Page {currentPage + 1} of {totalPages}
          </span>
          <a
            class="pagination-button"
            href={`?p=${currentPage + 1}`}
            aria-disabled={currentPage === totalPages}
            aria-label="Go to next page"
          >
            Next
          </a>
        </nav>
      )
    }
  </div>
</HomeLayout>
